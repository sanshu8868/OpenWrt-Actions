
#
#ç‰ˆæƒæ‰€æœ‰ ï¼ˆcï¼‰ 2019-2020 P3TERX <https://p3terx.com>
#
#è¿™æ˜¯æ ¹æ® MIT è®¸å¯è¯æˆæƒçš„å…è´¹è½¯ä»¶ã€‚
#æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… /LICENSEã€‚
#
# https://github.com/P3TERX/Actions-OpenWrt
#æè¿°ï¼š ä½¿ç”¨ GitHub Actions æ„å»º OpenWrt
#

åç§°ï¼š RAX3000Me

å¼€ï¼š
  æ¨é€ï¼š
    åˆ†æ”¯ï¼š
      - ä¸»è¦
    è·¯å¾„ï¼š
      - 'RAX3000Me/.config'
  workflow_dispatchï¼š
  æ—¶é—´è¡¨ï¼š
    - cronï¼š '0 0 1 * *'

ç¯å¢ƒï¼š
  REPO_URLï¼šhttps://github.com/dailook/immortalwrt-mt798x-23.05.git
  REPO_BRANCHï¼šopenwrt-23.05
  FEEDS_CONFï¼šRAX3000Me/feeds.conf.default
  CONFIG_FILEï¼šRAX3000Me/.config
  DIY_P1_SHï¼šRAX3000Me/diy1.sh
  DIY_P2_SHï¼šRAX3000Me/diy2.sh
  UPLOAD_FIRMWAREï¼šfalse
  UPLOAD_RELEASEï¼štrue
  TELEGRAM_BOT_TOKENï¼š${{ secretsã€‚TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHATIDï¼š${{ secretsã€‚TELEGRAM_CHATID }}
  TZï¼š äºšæ´²/ä¸Šæµ·

å·¥ä½œæœºä¼šï¼š
  buildï¼š
    è¿è¡Œæ—¶é—´ï¼š ubuntu-20.04

    æ­¥éª¤ï¼š
    - nameï¼š æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      ç”¨é€”ï¼šä½œ/checkout@main

    - nameï¼š åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      ç¯å¢ƒï¼š
        DEBIAN_FRONTENDï¼šéäº¤äº’å¼
      è¿è¡Œï¼š |
sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
sudo apt æ›´æ–°
sudo bash -c 'bash <ï¼ˆcurl -s https://build-scripts.immortalwrt.org/init_build_environment.shï¼‰'
sudo apt autoremove --purge
sudo apt æ¸…æ´
sudo timedatectl set-timezone â€œ$TZâ€
sudo mkdir -p /workdir
sudo chown $USERï¼š$GROUPS /workdir
echo â€œFIRMWARE_VERSION=$ï¼ˆdate +â€%y%m%dâ€œï¼‰â€ >> $GITHUB_ENV
echo â€œSTART_DATE=$ï¼ˆdate +%sï¼‰â€ >> $GITHUB_ENV
    - åç§°ï¼š ä¸‹è½½æºç 
      å·¥ä½œç›®å½•ï¼š/workdir
      è¿è¡Œï¼š |
df -hT $PWD
git clone --single-branch -b $REPO_BRANCH $REPO_URL openwrt
ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
    - åç§°ï¼š åŠ è½½è½¯ä»¶æº
      è¿è¡Œï¼š |
[ -e $FEEDS_CONF ] & mv $FEEDS_CONF openwrt/feeds.conf.default
chmod +x $DIY_P1_SH
CD OpenWRT
$GITHUB_å·¥ä½œåŒº/$DIY_P1_SH
    - nameï¼š æ›´æ–°å¹¶å®‰è£…è½¯ä»¶æº
      è¿è¡Œï¼šcd openwrt & ./scripts/feeds update -a & ./scripts/feeds install -a

    - nameï¼š åŠ è½½è‡ªå®šä¹‰é…ç½®
      è¿è¡Œï¼š |
[ -e RAX3000Me/æ–‡ä»¶] & mv RAX3000Me/æ–‡ä»¶openwrt/æ–‡ä»¶
[ -e $CONFIG_FILE ] & mv $CONFIG_FILE openwrt/.config
chmod +x $DIY_P2_SH
CD OpenWRT
$GITHUB_å·¥ä½œåŒº/$DIY_P2_SH
    - åç§°ï¼š ä¸‹è½½åŒ…
      idï¼šåŒ…
      è¿è¡Œï¼š |
CD OpenWRT
åˆ¶ä½œ defconfig
make download -j8
find dl -size -1024c -exec ls -l {} \;
find dl -size -1024c -exec rm -f {} \;
    - åç§°ï¼š ç¼–è¯‘å›ºä»¶
      idï¼šç¼–è¯‘
      è¿è¡Œï¼š |
CD OpenWRT
echo -e â€œ$ï¼ˆnprocï¼‰ çº¿ç¨‹ç¼–è¯‘â€
ä½¿ -j$ï¼ˆnprocï¼‰ ||ä½¿ -j1 ||ä½¿ -j1 V=s
echo â€œstatus=successâ€ >> $GITHUB_OUTPUT
    - åç§°ï¼š æ•´ç†æ–‡ä»¶
      IDï¼šç»„ç»‡
      å¦‚æœï¼šsteps.compile.outputs.status == 'æˆåŠŸ' & ï¼cancelledï¼ˆï¼‰
      è¿è¡Œï¼š |
# æ•´ç†å›ºä»¶åŒ…æ—¶å€™ï¼Œåˆ é™¤æ‚¨ä¸æƒ³è¦çš„å›ºä»¶æˆ–è€…æ–‡ä»¶ï¼Œè®©å®ƒä¸éœ€è¦ä¸Šä¼ åˆ°Actionsç©ºé—´
cd openwrt/bin/ç›®æ ‡/*/*
mkdir -p è½¯ä»¶åŒ…
mv packages åŒ…/æ ¸å¿ƒ
mv è½¯ä»¶åŒ…
mv $GITHUB_WORKSPACE/openwrt/bin/packages/*/* è½¯ä»¶åŒ…
tar -czf packages.tar.gz è½¯ä»¶åŒ…
rm -rf è½¯ä»¶åŒ…
rm -rf ç‰ˆæœ¬.buildinfo
rm -rf profiles.json
rm -rf *rootfs*
rm -rf å†…æ ¸
rm -rf *.manifest
rm -rf feeds.buildinfo
rm -rf sha256sums
rm -rf å·¥å…·é“¾
mv *sysupgrade.bin RAX3000Me-${{ env.FIRMWARE_VERSION }}-sysupgrade.bin ||echo æ²¡æœ‰æ‰¾åˆ° *sysupgrade.bin æ–‡ä»¶
mv *factory.bin RAX3000Me-${{ env.FIRMWARE_VERSION }}-factory.bin ||echo æ²¡æœ‰æ‰¾åˆ° *factory.bin æ–‡ä»¶
echo -e â€œ$ï¼ˆsha256sum *ï¼‰\nâ€ > sha256sums
echo â€œFIRMWARE=$PWDâ€ >> $GITHUB_ENV
echo â€œstatus=successâ€ >> $GITHUB_OUTPUT
    - nameï¼š ä¸Šä¼ å›ºä»¶åˆ°Github Actionsç©ºé—´
      å¦‚æœï¼š steps.organize.outputs.status == 'æˆåŠŸ' && env.UPLOAD_FIRMWARE == 'true'
      ä½¿ç”¨ï¼šactions/upload-artifact@main
      æ›¿æ¢ä¸ºï¼š
        åç§°ï¼š RAX3000Me-${{ env.FIRMWARE_VERSION }}
        è·¯å¾„ï¼š ${{ env.å›ºä»¶ }}

    - nameï¼š åˆ›å»ºreleaseæ ‡ç­¾
      idï¼š æ ‡ç­¾
      å¦‚æœï¼š steps.organize.outputs.status == 'æˆåŠŸ' & env.UPLOAD_RELEASE == 'true' && ï¼cancelledï¼ˆï¼‰
      è¿è¡Œï¼š |
echo â€œç¼–è¯‘æ—¶é—´ï¼š$ï¼ˆdate -d â€@${{ env.START_DATE }}â€œ +â€%Yå¹´%mæœˆ%dæ—¥ %Hç‚¹%Måˆ†â€œï¼‰â€ >> release.txt
echo â€œé»˜è®¤ç½‘å…³ï¼š${host_ip}â€ >> release.txt
echo åŒ…å«æ’ä»¶ï¼š$ï¼ˆgrep â€œCONFIG_PACKAGE_luci-app-\ï¼ˆ.*\ï¼‰=yâ€ openwrt/.config | sed â€œs/CONFIG_PACKAGE_luci-app-\ï¼ˆ.*\ï¼‰=y/\1/gâ€ | grep -v â€œ_\|arpbind\|autoreboot\|firewall\|mtk\|opkg\mtwifiâ€ï¼‰ >> release.txt
echo â€œstatus=successâ€ >> $GITHUB_OUTPUT
    - nameï¼š å°†å›ºä»¶ä¸Šä¼ åˆ°release
      ç”¨é€”ï¼šsoftprops/action-gh-release@v1
      å¦‚æœï¼šsteps.tag.outputs.status == 'æˆåŠŸ' & ï¼cancelledï¼ˆï¼‰
      ç¯å¢ƒï¼š
        GITHUB_TOKENï¼š ${{ ç§˜å¯†ã€‚GITHUB_TOKEN }}
      IDï¼šä¸Šä¼ -å‘å¸ƒ
      æ›¿æ¢ä¸ºï¼š
        åç§°ï¼š RAX3000Me-${{ env.FIRMWARE_VERSION }}
        tag_nameï¼šRAX3000Me
        body_pathï¼šrelease.txt
        æ–‡ä»¶ï¼š ${{ env.å›ºä»¶ }}/*

    - åç§°ï¼šTelegram é€šçŸ¥
      å¦‚æœï¼š env.TELEGRAM_CHATID & env.TELEGRAM_BOT_TOKEN
      å‡ºé”™æ—¶ç»§ç»­ï¼štrue
      è¿è¡Œï¼š |
duration=$ï¼ˆï¼ˆï¼ˆ$ï¼ˆdate +%sï¼‰-${{ env.START_DATE }}ï¼‰/60ï¼‰ï¼‰ && time=$ï¼ˆï¼ˆduration/60ï¼‰ï¼‰å°æ—¶$ï¼ˆï¼ˆduration%60ï¼‰ï¼‰åˆ†é’Ÿ
if [ â€œ${{ steps.compile.outputs.status }}â€ == 'æˆåŠŸ' ]; ç„¶å
content=â€œğŸ‰RAX3000Meå›ºä»¶ç¼–è¯‘æˆåŠŸğŸ‰%0Aå›ºä»¶ç‰ˆæœ¬ï¼š${{ env.FIRMWARE_VERSION }}%0Aç¼–è¯‘ç”¨æ—¶ï¼š${time}â€
è¿˜
content=â€œâŒRAX3000Meå›ºä»¶ç¼–è¯‘å¤±è´¥âŒ%0Aå›ºä»¶ç‰ˆæœ¬ï¼š${{ env.FIRMWARE_VERSION }}%0Aç¼–è¯‘ç”¨æ—¶ï¼š${time}â€
fi
curl â€œhttps://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessageï¼Ÿchat_id=${{ env.TELEGRAM_CHATID }}&text=${content}â€
